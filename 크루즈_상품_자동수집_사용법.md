# 크루즈 상품 자동 수집 시스템

웹사이트에서 크루즈 상품을 자동으로 가져와서 온보딩에 사용하는 시스템입니다.

## 📋 전체 프로세스

```
1. API 분석 (수동)
   ↓
2. API URL 설정
   ↓
3. 스크립트 실행
   ↓
4. 데이터베이스에 자동 저장
   ↓
5. 온보딩에서 사용 가능!
```

## 🔍 1단계: API 찾기

### 방법 1: Chrome 개발자 도구 사용 (권장)

`API_분석_가이드.md` 파일을 참고하여 다음 웹사이트들의 API를 찾아주세요:

- **CruiseDot**: https://www.cruisedot.co.kr/
- **WCruise**: https://www.wcruisenco.kr/

### 찾아야 할 정보

1. **API URL** (예: `https://www.cruisedot.co.kr/api/products`)
2. **응답 데이터 샘플** (JSON 형식)
3. **데이터 필드** (상품명, 가격, 일정 등)

### 예시

```json
// API 응답 예시
{
  "products": [
    {
      "id": "MSC-JP4N5D",
      "cruiseLine": "MSC",
      "ship": "MSC Bellissima",
      "title": "일본/대만 4박 5일",
      "nights": 4,
      "days": 5,
      "price": 1200000,
      "ports": [
        { "day": 1, "port": "Busan", "type": "embark" },
        { "day": 2, "port": "Fukuoka", "arrival": "08:00", "departure": "18:00" }
      ]
    }
  ]
}
```

## ⚙️ 2단계: 스크립트 설정

`scripts/import-cruise-products.mjs` 파일을 열어서 다음을 수정:

### 1) API URL 설정

```javascript
const API_ENDPOINTS = {
  cruisedot: {
    name: 'CruiseDot',
    url: 'https://www.cruisedot.co.kr/api/products', // 👈 여기에 실제 API URL
    headers: {
      'Accept': 'application/json',
      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
    }
  },
  wcruise: {
    name: 'WCruise',
    url: 'https://www.wcruisenco.kr/api/cruise/list', // 👈 여기에 실제 API URL
    headers: {
      'Accept': 'application/json',
      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
    }
  }
};
```

### 2) 데이터 변환 함수 수정

API 응답 구조에 맞게 `transformCruiseDotData`와 `transformWCruiseData` 함수를 수정:

```javascript
function transformCruiseDotData(apiData) {
  return {
    productCode: apiData.id,           // API 응답의 필드명에 맞게 수정
    cruiseLine: apiData.cruiseLine,    // API 응답의 필드명에 맞게 수정
    shipName: apiData.ship,            // API 응답의 필드명에 맞게 수정
    packageName: apiData.title,        // API 응답의 필드명에 맞게 수정
    nights: parseInt(apiData.nights),
    days: parseInt(apiData.days),
    basePrice: apiData.price ? parseInt(apiData.price) : null,
    description: apiData.description || null,
    itineraryPattern: transformItinerary(apiData.ports),
  };
}
```

## 🚀 3단계: 스크립트 실행

```bash
# 크루즈 상품 수집 스크립트 실행
node scripts/import-cruise-products.mjs
```

### 예상 출력

```
╔════════════════════════════════════════════════════════════╗
║          크루즈 상품 자동 수집 도구                        ║
╚════════════════════════════════════════════════════════════╝

============================================================
📍 CruiseDot 처리 시작
============================================================

📡 CruiseDot API 호출 중...
   URL: https://www.cruisedot.co.kr/api/products
✅ 응답 받음! (12345 bytes)

💾 5개 상품 저장 중...
✅ 저장됨: MSC-JP4N5D - MSC 크루즈 일본/대만 4박 5일
✅ 저장됨: RC-JP3N4D - Royal Caribbean 일본 규슈 3박 4일
...

📊 CruiseDot 결과:
   ✅ 저장: 5개
   ⏭️  건너뜀: 0개
   ❌ 실패: 0개

============================================================
🎉 전체 결과
============================================================
✅ 총 저장: 10개
⏭️  총 건너뜀: 0개
❌ 총 실패: 0개

🎊 성공! 이제 온보딩에서 새 상품을 사용할 수 있습니다!
```

## ✅ 4단계: 확인

### Prisma Studio로 확인

```bash
npx prisma studio
```

`CruiseProduct` 테이블을 열어서 저장된 상품들을 확인하세요.

### 온보딩에서 테스트

1. `/onboarding` 페이지로 이동
2. 저장된 상품 코드 입력 (예: `MSC-JP4N5D`)
3. 출발 날짜 선택
4. "여행 시작하기" 클릭
5. 자동으로 일정이 생성되는지 확인!

## 🔄 정기적 업데이트

### Cron Job 설정 (선택사항)

매일 자동으로 새 상품을 수집하려면:

```bash
# crontab 편집
crontab -e

# 매일 새벽 3시에 실행
0 3 * * * cd /path/to/cruise-guide && node scripts/import-cruise-products.mjs >> /var/log/cruise-import.log 2>&1
```

## 📊 데이터 구조

### CruiseProduct 테이블

| 필드 | 타입 | 필수 | 설명 |
|------|------|------|------|
| productCode | String | ✅ | 상품 코드 (고유값) |
| cruiseLine | String | ✅ | 크루즈 회사 (MSC, Costa 등) |
| shipName | String | ✅ | 선박명 |
| packageName | String | ✅ | 패키지명 |
| nights | Int | ✅ | 박수 |
| days | Int | ✅ | 일수 |
| itineraryPattern | Json | ✅ | 일정 패턴 (배열) |
| basePrice | Int | ❌ | 기본 가격 |
| description | String | ❌ | 설명 |

### itineraryPattern 구조

```json
[
  {
    "day": 1,
    "type": "Embarkation",
    "location": "Busan",
    "country": "KR",
    "currency": "KRW",
    "language": "ko",
    "time": "14:00"
  },
  {
    "day": 2,
    "type": "PortVisit",
    "location": "Fukuoka",
    "country": "JP",
    "currency": "JPY",
    "language": "ja",
    "arrival": "08:00",
    "departure": "18:00"
  },
  {
    "day": 3,
    "type": "Cruising"
  },
  {
    "day": 4,
    "type": "PortVisit",
    "location": "Taipei",
    "country": "TW",
    "currency": "TWD",
    "language": "zh-TW",
    "arrival": "09:00",
    "departure": "19:00"
  },
  {
    "day": 5,
    "type": "Disembarkation",
    "location": "Busan",
    "country": "KR",
    "currency": "KRW",
    "language": "ko",
    "time": "09:00"
  }
]
```

### type 종류

- `Embarkation`: 승선
- `PortVisit`: 기항지 방문
- `Cruising`: 해상 항해
- `Disembarkation`: 하선

## 🛠️ 문제 해결

### API URL을 못 찾겠어요

1. **상품 목록 페이지로 이동**
   - 메뉴에서 "크루즈 상품", "여행 상품" 클릭
   - Network 탭에서 XHR 요청 확인

2. **여전히 안 보인다면**
   - 서버 사이드 렌더링(SSR)일 수 있음
   - HTML 파싱 방식으로 변경 필요
   - 또는 여행사에 API 문의

### 데이터 변환이 안 돼요

1. **API 응답 구조 확인**
   ```bash
   # API 응답을 파일로 저장
   curl "API_URL" > response.json
   cat response.json
   ```

2. **변환 함수 수정**
   - `transformCruiseDotData` 함수에서 필드명 확인
   - `console.log(apiData)` 추가해서 디버깅

### 저장이 안 돼요

1. **데이터베이스 연결 확인**
   ```bash
   npx prisma studio
   ```

2. **필수 필드 누락 확인**
   - productCode, cruiseLine, shipName, packageName 필수
   - nights, days는 0 이상의 숫자여야 함

3. **중복 상품 코드**
   - productCode가 이미 존재하는 경우 건너뜀
   - 새 상품인데도 건너뛰어진다면 productCode 생성 로직 확인

## 🎯 다음 단계

1. ✅ API 찾기 (`API_분석_가이드.md` 참고)
2. ✅ 스크립트 설정 (`scripts/import-cruise-products.mjs`)
3. ✅ 스크립트 실행 (`node scripts/import-cruise-products.mjs`)
4. ✅ 온보딩에서 테스트

## 📞 도움이 필요하신가요?

- API 응답 샘플을 공유해주시면 변환 함수를 작성해드립니다!
- 문제가 생기면 오류 메시지와 함께 문의해주세요.

---

**작성일**: 2025-11-06
**버전**: 1.0
