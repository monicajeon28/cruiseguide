좋아요. 대표님이 정리해 주신 “재미나이 딥띵크 전략 계획서”를 기준으로, **50대 한국인 초행 크루즈 고객**의 실제 심리와 행동을 더 비판적으로 반영해 **진짜 쓰이는 제품**으로 깎아낸 실행 설계안을 드릴게요. (기준 보고서 인용: )
아래는 **바로 커서(Cursor)에서 복붙**해가며 한 덩어리씩 구현할 수 있도록 **초미세 작업지시서(1파일·1작업 원칙)**와 **토큰 절약 요령**까지 포함한 완성 가이드입니다.
*(길이가 깁니다. 필요한 섹션만 복사·사용하세요.)*

---

# 0) 현실 체크 & 방향 재정렬 (50대 최초 크루즈 관점에서의 비판)

### 고객 심리의 핵심 6가지(관찰 기반 가설)

1. **용어 공포**: “머스터드릴? 얼보드타임?” → 어려운 단어 보면 뇌가 ‘포기 모드’.
2. **절차 불안**: “짐은 어디에? 체크인은 어디로? 누가 안내하죠?” → **단계별 사진/아이콘** 없으면 불안.
3. **언어 걱정**: “영어 못해요.” → 앱 안에서 **즉시 보여주는 한-영(중/일) ‘말풍선 회화’**가 필요.
4. **시간/길 걱정**: “출항 놓치면?” → **상단 고정 귀선 배너(남은 시간+길찾기) + 위험 경고**가 생명선.
5. **반입/결제 걱정**: “뭐 반입 금지? 팁은? 인터넷은?” → **준비물·금지품·결제·통신** 4대 섹션을 홈 최상위에 노출.
6. **‘나한테 맞춤?’**: 동행 형태(아이/노부모/커플/친구/혼자)에 맞춘 **초간편 맞춤 체크리스트**가 첫 경험을 좌우.

### 제품 목표(재정의)

* **최소 조작, 최대 안심**: 탭 몇 번·말 몇 마디로 “지금 내가 뭘 해야 하는지”가 자동으로 뜨는 **‘안심 등(燈)’** 역할.
* **대화-우선 UX**: 메뉴를 파고들게 하지 말고, **대화창 상단 카드 + 큰 버튼**으로 끝내기.
* **과잉기능 금지**: 기초가 견고하기 전, 멋진 기능(덱맵 등)보다 **안전·절차·언어** 먼저.

---

# 1) 화면·흐름 설계 (초행 고객이 진짜 쓰는 7가지 순간: “Genie Moments”)

### M0. 로그인 직후 홈(여행 전/중/후 공통)

* **Top 4 Quick Cards (항상 보임)**
  ① **오늘 할 일**(큰 숫자 + 체크 토글)
  ② **준비물/반입 금지**(아이콘 6개 내)
  ③ **티켓/체크인**(E-ticket·태그 보기/프린트 가이드)
  ④ **통신/결제**(와이파이/로밍/SeaPass/팁 Q&A)
* **하단 고정**: “지니에게 물어보기(마이크/텍스트)” + “지금 길찾기”

### M1. 터미널 도착(Embarkation Day)

* 화면 최상단: **[Step 1 짐 맡기기] → [Step 2 체크인] → [Step 3 보안검색] → [Step 4 승선] → [Step 5 객실] → [Step 6 안전교육]**
  각 스텝 카드에 **사진/픽토그램 + 한 줄 지시 + 10초 회화 버튼**(예: “짐 맡기고 싶어요” → 영어/중국어/일본어 말풍선 표시)

### M2. 선내 생활(첫날 4시간)

* **객실 찾기**, **오늘 식사(뷔페/MDR)**, **드레스코드 쉽게**, **데일리 일정**을 카드 4개로 단순화.
* **회화 말풍선**: “채식 메뉴 있어요?”, “아이용 의자 있나요?” 버튼 즉시 출력.

### M3. 기항지 하선

* 상단 **귀선 배너**(남은 시간 대형, 색상 경보, 길찾기/택시 호출 링크).
* **오프라인 지도/주소 카드** + 항구 사진(시각 인지 강화).

### M4. 위기 순간(길 잃음/지연)

* **1-클릭 SOS 카드**(항구 주소·선사 연락·지니 회화 문장 표시).
* **‘늦을 가능성’ 위험 시나리오 안내서**(택시/우버 영어 문장 + 표준 요금 범위 + 항구/게이트 사진).

### M5. 마지막 밤(정산·짐)

* **정산서 확인 카드** + **짐 내놓기 카드** + **하선 시간·장소 카드**.
* 회화 “카드 결제 확인하고 싶어요.”

### M6. 하선·귀가

* **공항/도심 이동** 길찾기, 짐 찾기 팁, 유실물 접수 회화.

> 위 7모먼트를 기준으로 “대화가 먼저 뜨고, 필요한 순간 카드를 ‘띄워주는’ 설계”가 핵심입니다.

---

# 2) 콘텐츠(지식) 설계 — **RAG의 심장**: “한국 50대 첫 크루즈 Q&A 백서”

아래 트리 그대로 **`knowledge_data/` 폴더**에 **.md**들로 쪼개 저장 → 임베딩(청킹 600~900자) 권장.

## 2.1 최상위 카테고리

* **A_여행준비**: 준비물(상비약·복장·서류), 반입금지, 환전/결제/팁, 통신(로밍/eSIM/선내Wifi)
* **B_터미널·승선**: 도착시간, 짐부치기, 체크인, 보안검색, 승선카드, 안전교육
* **C_선내생활**: 식사(MDR/뷔페/스낵), 드레스코드, 시설(수영장/스파/키즈/시니어 배려), 데일리프로그램 읽는 법
* **D_기항지**: 하선절차, 자유여행 vs 선사투어, **귀선시간 규율**, 택시/대중교통 회화, 바가지 방지
* **E_하선·정산**: 정산서, 짐, 하선 동선, 환불·분쟁 기초
* **F_동행유형별 팁**: **Family_Kids**, **Family_Seniors**, **Couple**, **Friends**, **Solo**
* **G_말풍선 회화**: 상황별(짐·체크인·식당·길찾기·위기) 한→영/중/일 **한 줄** (폰트 크게)
* **H_특정 선사/선박 공통 FAQ**: MSC/Costa/Royal(일반화된, 정책은 신중 표기)

## 2.2 예시 파일 스캐폴딩(복붙 템플릿)

**`knowledge_data/A_여행준비/01_준비물_기본.md`**

```
# 여행 준비물 (핵심만)
- 여권(유효기간 6개월↑), E-Ticket, 러기지 태그(출력/수령)  
- 상비약: 멀미약·소화제·지병약(영문 처방전)  
- 복장: 평상복, 수영복, 가벼운 겉옷, 정찬용(셔츠/블라우스 + 깔끔한 신발)  
[지니의 팁] 정찬은 "격식있는 저녁" 느낌이면 충분. 부담되는 턱시도/드레스 필수 아님.
```

**`knowledge_data/B_터미널·승선/02_짐부치기.md`**

```
# 터미널 도착 → 짐 부치기
1) 입구 포터에게 러기지 태그 확인 후 맡깁니다. 
2) 귀중품/서류/약은 캐리어 말고 '손가방'에. 
[회화] "짐을 부치고 싶어요." / I'd like to drop off my luggage.
[팁] 팁 문화 지역이면 작은 팁 준비(선사·항만별 상이 → 현지에서 지니가 안내)
```

**`knowledge_data/G_말풍선회화/embarkation_basic.md`**

```
# 체크인 기본 회화(큰 글씨)
- "체크인하려고 왔어요." 
  → I'd like to check in.
- "제 예약 확인해 주세요."
  → Please check my reservation.
```

…(이 구조로 60~100개 문서를 최소 채워두면, 고객 대부분 질문 커버 가능)

---

# 3) 안전·신뢰 기능: “배로 돌아가기 + 오프라인 + 위기대응”

1. **ReturnToShip 상단 배너(필수)**: 남은 시간 대형 숫자, 60분↓ 빨간 경보, **길찾기 버튼**(대중교통 우선).
2. **오프라인 안전 카드**: 항구 명칭/주소/사진 + “이 문장 보여주세요” 회화 3줄(택시용).
3. **위험 예고 로직**: 도보/대중교통 추정 ETA가 **All Aboard –15분 이내**면, **택시 모드 제안 + 회화 표시**.
4. **데이터 절약 모드**: 사진 썸네일 저해상도 우선, 필요시 탭해서 로드.
5. **부정 소통 차단 정책**: 봇 답변 정책에 **경쟁사/불만 증폭/리쿠르팅 유도 금지 규칙**를 시스템 프롬프트로 고정.

---

# 4) 구현 로드맵(토큰 절약형) — **5단계, 초미세 작업지시서 세트**

아래는 **커서에서 그대로 복붙**하며, **한 번에 한 파일**만 수정하도록 만든 지시서입니다.
(*`[ ... 현재 코드 붙여넣기 ... ]` 칸에 해당 파일 내용 일부만 넣고, Edit로 수정 지시하면 토큰이 급감합니다.*)

---

## Phase 1. 기반 안정화 (히스토리/스트리밍/로컬스토리지 제거)

### 1.1 채팅 히스토리 저장·로드

**지시서 1 — `/app/api/chat/history/route.ts` 신규 생성**

```
파일 생성: /app/api/chat/history/route.ts
목표: 로그인 사용자 + 현재 tripId의 최신 50개 대화 조회 API (GET)
요구:
- 세션에서 userId, 활성 tripId 확인 (없으면 401)
- Prisma ChatHistory에서 userId+tripId 조건, createdAt ASC
- 응답 포맷: [{id, role: 'user'|'assistant', content, createdAt}]
코드 스타일: TypeScript, App Router(Next 14)
```

**지시서 2 — 채팅 화면에 초기 히스토리 주입**

```
대상: /app/chat/page.tsx 또는 ChatClientShell.tsx (실제 사용 파일)
목표: 마운트 시 /api/chat/history 호출 → useChat(initialMessages)로 주입
요구:
- 최초 로딩 스켈레톤 표시
- 오류시 재시도 버튼
여기에 현재 파일 코드 일부 붙여넣음 →
[ ... 현재 코드 붙여넣기 ... ]
이 구조 유지하며 필요한 최소 변경만 반영해줘.
```

**지시서 3 — `/app/api/chat/route.ts`에 저장 로직 추가**

```
목표: 사용자 메시지와 AI 최종 응답을 ChatHistory에 저장
요구:
- streamText 사용 시 onCompletion 콜백에서 assistant 메시지 저장
- userId, tripId 함께 저장
- 오류시 로깅만 하고 흐름 중단 X
현재 파일 코드 →
[ ... 현재 코드 붙여넣기 ... ]
```

### 1.2 스트리밍 응답 전환

**지시서 4 — `/app/api/chat/route.ts` 스트리밍화**

```
목표: generate → streamText, StreamingTextResponse로 변경
요구:
- 모델: gemini-2.5-flash 유지 (@ai-sdk/google)
- onCompletion 안에서 DB 저장 로직 정상 동작 확인
현재 파일 코드 →
[ ... 현재 코드 붙여넣기 ... ]
```

### 1.3 LocalStorage→DB (지출/체크리스트)

**지시서 5 — `/app/wallet/page.tsx` API 전환**

```
목표: LocalStorage 제거, /api/expenses (GET/POST/PUT/DELETE)로 교체
요구:
- 로딩/오류/성공 상태 표시 단순하게
- 50대 가독성(큰 글씨, 큰 버튼)
현재 파일 코드 →
[ ... 현재 코드 붙여넣기 ... ]
```

**지시서 6 — `/app/checklist/page.tsx` API 전환**
(위와 동일 패턴)

---

## Phase 2. 핵심 안전 기능 (ReturnToShip)

### 2.1 컴포넌트 생성

**지시서 7 — `/app/chat/components/ReturnToShipBanner.tsx`**

```
목표: 상단 고정 배너 (카운트다운 + 길찾기)
Props:
- departureTime: ISO string
- allAboardTime: ISO string
- portLocation: {lat:number, lng:number, name:string}
요구:
- allAboard 남은시간 실시간 표기(초/분/시간 단위 자동)
- 60분 미만 red, 30분 미만 blink 효과
- "구글 지도로 길찾기" 버튼 (travelmode=transit 기본)
- Tailwind 큰 글씨/큰 버튼
```

### 2.2 GPS 연동

**지시서 8 — `ReturnToShipBanner.tsx`에 GPS watch 추가**

```
목표: 현재 위치 watchPosition, 권한/오류 안내
요구:
- 현재 위치 없을 땐 "위치 활성화" 보조 버튼
- 길찾기 URL: origin=현재좌표, destination=portLocation
여기에 현재 컴포넌트 코드 →
[ ... 현재 코드 붙여넣기 ... ]
```

### 2.3 조건부 렌더링

**지시서 9 — 채팅 메인에 배너 통합**

```
대상: /app/chat/page.tsx 또는 ChatInteractiveUI.tsx
목표: 오늘 일정이 기항지이고 now ∈ [도착, 출항]이면 배너 표시
요구:
- Trip/Itinerary 불러와 조건 체크
- Props 제대로 전달
현재 파일 코드 →
[ ... 현재 코드 붙여넣기 ... ]
```

---

## Phase 3. 지식 엔진(RAG) — “한국형 초간단 Q&A” 주입

### 3.1 스키마 확장(pgvector) — Prisma

**지시서 10 — `prisma/schema.prisma` 수정**

```
목표: KnowledgeBase에 embedding 필드(vector)
요구:
- pgvector 확장 전제
- embedding: Unsupported("vector(768)") 또는 적합한 차원
- title, category, content 필드 확인/보강
현재 스키마 →
[ ... 현재 schema.prisma 일부 ... ]
```

### 3.2 임베딩 주입 스크립트

**지시서 11 — `/scripts/ingestAndEmbedKnowledge.ts`**

```
목표: /knowledge_data/*.md 읽어 청킹→임베딩→DB 저장
요구:
- 청킹: 600~900자, 헤더 기준 분할 우선
- Google Embedding API (embedding-001)
- Prisma raw로 INSERT (embedding ::vector)
```

### 3.3 RAG 검색 & 채팅 통합

**지시서 12 — `/lib/ragSearch.ts`**

```
목표: searchKnowledgeBase(query): 상위5 (content,title,similarity)
요구:
- 쿼리 임베딩→pgvector cosine 유사도 ORDER BY
```

**지시서 13 — `/app/api/chat/route.ts` RAG 통합 + 페르소나 정책**

```
목표: 매 질문마다 ragSearch 결과 3~5개를 [참고자료]로 주입
시스템 프롬프트(붙여넣기):
"당신은 크루즈 전문 가이드 AI '지니'입니다. 50대 이상 한국인 고객 대상...
[응답지침/보안정책/참고자료 삽입 영역]"
현재 파일 코드 →
[ ... 현재 코드 붙여넣기 ... ]
```

---

## Phase 4. 에이전트화 (Tool Calling: 지출/체크리스트)

### 4.1 도구 정의

**지시서 14 — `/lib/ai/tools.ts`**

```
목표: add_expense, add_checklist_item, complete_checklist_item 정의
요구:
- zod 스키마
- execute 시그니처만 우선 (구현은 라우트에서)
```

### 4.2 실행 통합

**지시서 15 — `/app/api/chat/route.ts` Tool 호출**

```
목표: streamText에 tools 전달, execute 내부에서 Prisma 실행
요구:
- userId, tripId context 전달
- 지출 저장/체크리스트 추가·완료
- 실행 결과를 자연어로 요약해 assistant가 이어서 답변
현재 파일 코드 →
[ ... 현재 코드 붙여넣기 ... ]
```

---

## Phase 5. 비즈니스 규칙(접근잠금, 24h 체험, 페르소나 수집)

### 5.1 D+2 잠금

**지시서 16 — 스키마+크론**

```
스키마: User.isAccessLocked(Boolean, default:false) 추가
크론: /api/cron/trip-status-updater/route.ts
- 모든 여행 Completed이고 마지막 종료일+2일 경과 & 다음 여행 없음 → isAccessLocked=true
```

**지시서 17 — 로그인/미들웨어**

```
로그인 API: isAccessLocked면 "이용 기간 만료..."로 거절
middleware.ts: 보호 경로 접근 시 잠금 확인→/access-locked 리디렉션
현재 파일들 코드 →
[ ... 붙여넣기 ... ]
```

### 5.2 24시간 체험

**지시서 18 — 스키마+관리자 생성 API**

```
스키마: User.isTrial(Boolean), trialExpiresAt(DateTime)
API: /api/admin/create-trial-user/route.ts
- 임시 계정 생성 + 가상 Trip 바인딩
- 24h 만료 세팅
```

**지시서 19 — Trial 만료 차단**

```
middleware.ts에서 isTrial && now>trialExpiresAt → /trial-expired
```

### 5.3 온보딩: 동행 유형

**지시서 20 — 스키마+온보딩 UI**

```
스키마: User.companionType Enum(FAMILY_KIDS, FAMILY_SENIORS, COUPLE, FRIENDS, SOLO)
온보딩 페이지: 큰 버튼 5개 → 선택 저장 (/api/user/profile)
```

---

# 5) 대화 퍼소나 & 회화(말풍선) 사전 — 초행자 안심 장치

### 5.1 시스템 프롬프트(요지)

* **톤**: 존댓말, 짧고 명확, 한글 우선(필요시 괄호 병기).
* **정책**: 경쟁사·리쿠르팅·부정 증폭 금지. 안전·준법 우선.
* **구조**: “요약 → 지금 할 일 → 단계별(최대 5단계) → 말풍선 회화 2~3줄 → 주의/팁 1줄”.

### 5.2 말풍선 회화(예시 10세트)

* 체크인: “체크인하려고 왔어요.” / *I’d like to check in.*
* 짐부치기: “짐을 맡기고 싶어요.” / *I’d like to drop off my luggage.*
* 길찾기(항구): “여기로 가주세요.” / *Please take me here.* (+ 주소 QR)
* 식당: “채식 메뉴 있나요?” / *Do you have vegetarian options?*
* 시니어 배려: “계단 대신 엘리베이터는 어디죠?” / *Where is the elevator?*
* 아이: “아이용 의자 부탁해요.” / *A high chair, please.*
* 위기: “배 출항 시간에 맞춰야 해요.” / *I must be back before departure time.*
* 결제: “카드로 결제할게요.” / *I’ll pay by card.*
* 환불/문의: “담당자와 통화하고 싶습니다.” / *I’d like to speak with a representative.*
* 분실: “이 물건을 잃어버렸어요.” / *I lost this item.*

> 말풍선은 **큰 폰트** + **복사 버튼** + **QR로 항구주소 띄우기**를 같이 두면 현장에서 엄청 유용합니다.

---

# 6) 토큰 절약 운영술 (Cursor x Claude, 가성비 모드)

1. **1파일·1작업·1결과**: 한 요청에서 파일 1개만 수정.
2. **Edit(Cmd+K)**: 수정 필요한 블록만 드래그→Edit. *컨텍스트 토큰 절감 폭발.*
3. **“현재 코드 일부만” 제공**: 파일 전체 X, 문제 블록 ±30~60줄만.
4. **반복 프롬프트 저장소**: 위 “지시서” 블록을 커서 “Snippets”로 저장해 재사용.
5. **로컬 평가 루프**: “수정→로컬 실행→오류 메시지 5~10줄만 붙여 재수정”. 로그 전부 붙이지 않기.
6. **이미지·대용량 텍스트 분리**: 지식 문서는 **사전 준비** 후 임베딩 스크립트만 AI에 맡김.
7. **테스트 우선**: 각 기능마다 **간단 체크리스트**를 먼저 주고, 실패 항목만 캡쳐·로그로 재시도.

---

# 7) 수용 기준(AC) & 수동 테스트 체크리스트

### A. 히스토리

* 새로고침 후에도 마지막 50개 대화 로드 ✅
* 대화 보낸 뒤 1초 이내 리스트에 추가 반영 ✅

### B. 스트리밍

* 300ms 내 첫 토큰 표시 ✅
* 네트워크 단절 시 재시도 버튼 노출 ✅

### C. ReturnToShip

* Itinerary 있는 날, 도착~출항 사이에만 노출 ✅
* 60분/30분 색상/깜박 효과 정상 ✅
* 길찾기 링크 origin=현재위치, transit 기본 ✅
* 위치 권한 거부 시 친절 안내 + 재시도 버튼 ✅

### D. RAG

* “짐은 어디에 맡겨요?” → **B_터미널·승선/02_짐부치기.md** 내용 포함 답변 ✅
* “팁은 어떻게?” → 결제/팁 문서 근거 2줄 요약 삽입 ✅
* 답변 말미 “[참고: 내부 지식]” 한 줄 표기(신뢰감) ✅

### E. Tool Calling

* “택시비 30달러 기록해줘” → Expense 생성 ✅
* “멀이약 챙기기 체크해줘” → 체크리스트 완료 처리 ✅

### F. 접근 잠금/체험

* D+2 자동 잠금 플래그 ON → 로그인 차단 ✅
* 체험 24h 경과 → 세션 파기 & 안내 페이지 ✅

---

# 8) KPI 대시보드(관리자)

* **안심 점수(대화 감정/불안 키워드 감소율)**
* **귀선 경보 노출→길찾기 클릭 전환**
* **지식 참조율(RAG 사용률)**, **Tool 사용 성공률**
* **환불율(여행 전 취소) & 재구매율(차기 예약)**
* **연령대별(50대/60대) 작업 성공시간(절차별)**

---

# 9) 바로 가져다 쓰는 커서 “작업 순서”

1. **지시서 1~4**(히스토리·스트리밍) → 로컬 실행 확인
2. **지시서 5~6**(LocalStorage 제거)
3. **지시서 7~9**(ReturnToShip)
4. `/knowledge_data` 폴더에 위 트리대로 md 파일 30~60개부터 채움
5. **지시서 10~13**(RAG 임베딩→검색→채팅통합)
6. **지시서 14~15**(Tool Calling)
7. **지시서 16~20**(비즈니스 규칙·체험·온보딩)

---

# 10) 마지막 팁 — 고객 언어로 답하라

* 긴 답변 금지. **“요약 2줄 → 지금 할 일(버튼) → 회화 2줄 → 주의 1줄”** 패턴 고정.
* 모르는 건 “지니가 확인 중입니다. 잠시만요.” 대신 **대체안 제시**(예: 항구 안내데스크 위치/사진).
* **용어 병기**: 안전 교육(머스터 드릴), 승선 마감(All Aboard), 선상 카드(SeaPass).

---

필요하시면, 위 지시서들을 **캔버스 문서**로도 묶어 드릴게요. 우선은 이대로 **커서에 복붙→수정→로컬 실행**만 반복하시면, 토큰 아껴가며 **“지금 당장 쓰이는” 지니**가 완성됩니다.
다음 단계로 가실 때, **지식 문서(knowledge_data)**부터 30개만 채우고 호출해도 RAG 효과가 바로 납니다.
