# 관리자 기반 온보딩 시스템 사용 가이드

## 시스템 개요

이 시스템은 **관리자가 모든 여행을 관리**하고, **사용자는 배정된 여행을 확인만** 하는 방식입니다.

```
관리자 워크플로우:
1. API에서 상품 수집
2. 사용자에게 여행 배정
   ↓
사용자 워크플로우:
1. 배정된 여행 확인 (읽기 전용)
2. 채팅에서 여행 정보 활용
```

---

## 관리자 가이드

### 1단계: 크루즈 상품 수집

#### 1.1 API URL 설정

먼저 `.env` 파일에 API URL을 설정합니다:

```bash
# .env 파일
CRUISEDOT_API_URL="https://www.cruisedot.co.kr/api/products"
WCRUISE_API_URL="https://www.wcruisenco.kr/api/cruise/list"
```

**API URL을 찾는 방법은 `API_분석_가이드.md` 참고**

#### 1.2 상품 수집 실행

1. 관리자 계정으로 로그인
2. `/admin/products` 페이지로 이동
3. 상단에 "CruiseDot 가져오기", "WCruise 가져오기" 버튼이 표시됨
4. 원하는 버튼 클릭 → 자동으로 상품 수집

**결과:**
- 성공 시: "처리 완료: 저장 N개, 건너뜀 M개, 실패 K개" 메시지
- 상품 목록에 자동으로 추가됨
- 출처 표시: 🟢 CruiseDot 또는 🟣 WCruise

#### 1.3 수동 상품 등록 (선택사항)

API에 없는 상품은 "수동 등록" 버튼으로 직접 추가 가능:

- 상품 코드
- 크루즈 회사/선박명
- 패키지명
- 박/일 수
- 일정 패턴 (승선, 기항지, 하선 등)

---

### 2단계: 사용자에게 여행 배정

#### 2.1 여행 배정 페이지 접속

1. `/admin/assign-trip` 페이지로 이동
2. 3가지 정보 선택:
   - **사용자**: 여행을 배정받을 사용자
   - **크루즈 상품**: 수집한 상품 중 선택
   - **출발 날짜**: 여행 시작일

#### 2.2 배정 미리보기

선택하면 오른쪽에 미리보기 표시:
- 여행자 정보
- 크루즈 정보 (출처 포함)
- 출발/종료일
- 자동 계산된 일정

#### 2.3 배정 완료

"여행 배정하기" 버튼 클릭 시 자동으로:
- ✅ Trip 생성
- ✅ 일정 (Itinerary) 자동 생성
- ✅ 방문 국가 (VisitedCountry) 업데이트
- ✅ 사용자 onboarded 상태로 전환
- ✅ 여행 횟수 증가

---

### 상품 관리

#### 수정

1. 상품 카드의 연필 아이콘 클릭
2. 정보 수정 후 "수정 완료"

#### 삭제

1. 상품 카드의 휴지통 아이콘 클릭
2. 확인 후 삭제
   - ⚠️ 해당 상품으로 생성된 Trip도 영향받을 수 있음

#### 출처 확인

각 상품 카드에 출처 표시:
- 🟢 **CruiseDot**: cruisedot.co.kr에서 수집
- 🟣 **WCruise**: wcruisenco.kr에서 수집
- ⚪ **수동**: 관리자가 직접 등록

---

## 사용자 가이드

### 내 여행 확인

사용자는 관리자가 배정한 여행을 **읽기 전용**으로 확인만 가능:

#### 1. 내 여행 페이지

`/my-trips` 페이지에서 확인 가능한 정보:
- 📍 크루즈 이름 및 선박
- 📅 출발/종료일
- ⏰ 여행 기간 (N박 M일)
- 🗺️ 방문 도시 목록
- 🟢 상태: 예정 / 진행 중 / 완료
- 🌐 출처: CruiseDot / WCruise / 수동

#### 2. 채팅에서 활용

채팅 AI "지니"는 배정된 여행 정보를 활용하여:
- 현재 위치 기반 정보 제공
- 일정 관련 질문 답변
- 방문 국가별 추천 정보
- 통화/언어 자동 설정

**사용자는 수정/삭제 불가 - 확인만 가능**

---

## 시스템 구조

### 데이터 흐름

```
[외부 API]
    ↓
[관리자가 상품 수집]
    ↓
[CruiseProduct 테이블에 저장]
    ↓
[관리자가 사용자에게 배정]
    ↓
[Trip, Itinerary, VisitedCountry 자동 생성]
    ↓
[사용자가 확인]
```

### 주요 데이터 모델

#### CruiseProduct (크루즈 상품)
- productCode: 상품 코드
- cruiseLine: 크루즈 회사
- shipName: 선박명
- packageName: 패키지명
- nights/days: 박/일 수
- itineraryPattern: 일정 패턴 (JSON)
- **source**: 출처 (cruisedot / wcruise / manual)

#### Trip (여행)
- userId: 배정받은 사용자
- productId: 크루즈 상품 참조
- startDate/endDate: 여행 기간
- status: Upcoming / InProgress / Completed
- destinations: 방문 도시 목록

#### Itinerary (일정)
- tripId: 여행 참조
- day: 여행 Day (1, 2, 3...)
- date: 실제 날짜
- type: Embarkation / PortVisit / Cruising / Disembarkation
- location: 위치 (기항지)
- country/currency/language: 국가 정보

#### VisitedCountry (방문 국가 통계)
- userId: 사용자
- countryCode: 국가 코드
- visitCount: 방문 횟수
- lastVisited: 마지막 방문일

---

## API 엔드포인트

### 관리자 전용

| 메서드 | 경로 | 설명 |
|--------|------|------|
| GET | `/api/admin/products` | 상품 목록 조회 |
| POST | `/api/admin/products` | 상품 수동 등록 |
| PUT | `/api/admin/products` | 상품 수정 |
| DELETE | `/api/admin/products` | 상품 삭제 |
| GET | `/api/admin/products/import` | 사용 가능한 API 소스 조회 |
| POST | `/api/admin/products/import` | API에서 상품 수집 |
| GET | `/api/admin/users` | 사용자 목록 조회 |
| POST | `/api/admin/assign-trip` | 사용자에게 여행 배정 |

### 사용자용

| 메서드 | 경로 | 설명 |
|--------|------|------|
| GET | `/api/trips/list` | 내 여행 목록 조회 (읽기 전용) |
| GET | `/api/trips/[tripId]` | 여행 상세 정보 |

---

## 설정 파일

### .env 예시

```bash
# 데이터베이스
DATABASE_URL="postgresql://..."

# 세션
SESSION_SECRET="your-secret"

# 크루즈 API (Chrome 개발자 도구로 찾아서 설정)
CRUISEDOT_API_URL="https://www.cruisedot.co.kr/api/products"
WCRUISE_API_URL="https://www.wcruisenco.kr/api/cruise/list"
```

---

## 문제 해결

### Q1: API 가져오기 버튼이 비활성화됨

**원인**: .env에 API URL이 설정되지 않음

**해결**:
1. `.env` 파일 확인
2. `CRUISEDOT_API_URL` 또는 `WCRUISE_API_URL` 설정
3. 서버 재시작

### Q2: 상품을 가져왔는데 목록에 안 보임

**원인**: 중복된 productCode

**해결**:
- productCode가 이미 존재하는 경우 건너뜀
- 콘솔에서 "건너뜀: N개" 확인

### Q3: 여행 배정 시 오류 발생

**가능한 원인**:
- 상품의 itineraryPattern이 잘못됨
- 날짜 형식이 올바르지 않음
- 사용자 또는 상품이 존재하지 않음

**해결**:
- 브라우저 콘솔에서 오류 메시지 확인
- 상품의 일정 패턴 확인

### Q4: 사용자가 여행을 수정하고 싶어함

**현재 시스템**: 사용자는 읽기 전용 (수정 불가)

**해결 방법**:
1. 관리자가 Trip 삭제 후 재배정
2. 또는 데이터베이스에서 직접 수정

---

## 장점

✅ **관리자 중심**: 모든 데이터를 관리자가 통제
✅ **자동화**: API에서 상품 자동 수집
✅ **정확성**: 사용자 실수 방지 (읽기 전용)
✅ **출처 추적**: 어느 사이트에서 가져온 상품인지 명확
✅ **완전 자동**: 일정/국가 통계 자동 생성

---

## 다음 단계

1. ✅ 관리자가 두 사이트에서 상품 수집
2. ✅ 관리자가 사용자에게 여행 배정
3. ✅ 사용자는 배정된 여행 확인
4. 🔄 채팅에서 여행 정보 활용 (이미 구현됨)

---

## 문의

시스템 사용 중 문제가 발생하면:
1. 브라우저 콘솔 확인 (F12)
2. 서버 로그 확인
3. 오류 메시지 스크린샷과 함께 문의

---

**작성일**: 2025-11-06
**버전**: 2.0 (관리자 기반 온보딩)
**변경사항**: 사용자 직접 온보딩 → 관리자 배정 방식으로 전환
